# Makefile for fetchmail

# If you're running QNX, we can't assume a working autoconf.
# So just uncomment all the lines marked QNX.

VERS=4.4.9

# Ultrix 2.2 make doesn't expand the value of VPATH.
srcdir = @srcdir@
VPATH = @srcdir@

CC = @CC@
# CC = cc		# QNX

CFLAGS = @CFLAGS@
# CFLAGS =  -g2 -5	# QNX
LDFLAGS = @LDFLAGS@
# LDLAGS =  -g2 -5	# QNX
LEX = @LEX@
LEXFLAGS=
YACC = @YACC@
# YACC = yacc
YACCFLAGS = -dt

CEFLAGS = @CEFLAGS@
LDEFLAGS = @LDEFLAGS@

# How to invoke ranlib.  This is only used by the `glob' subdirectory.
RANLIB = @RANLIB@

# NeXT 1.0a uses an old version of GCC, which required -D__inline=inline.
# See also `config.h'.
DEFS = @DEFS@ @EXTRADEFS@
# DEFS = -DQNX -DHAVE_CONFIG_H -DHAVE_UNISTD_H -DHAVE_STDARG_H -DSTDC_HEADERS	# QNX
defines =  -DRELEASE_ID=\"$(VERS)\" $(DEFS)

# If your system needs extra libraries loaded in, define them here.
# In particular, add -lresolv if you are running bind 4.9.5
LOADLIBS = @LIBS@ @LEXLIB@
# LOADLIBS = -lsocket3r -lunix3r	# QNX

# Any extra object files your system needs.
extras = @LIBOBJS@

# Extra sources/objects for library functions not provided on the host system.
EXTRASRC = @EXTRASRC@
# EXTRASRC = $(srcdir)/strcasecmp.c $(srcdir)/getopt.c $(srcdir)/getopt1.c $(srcdir)/alloca.c	# QNX
EXTRAOBJ = @EXTRAOBJ@
# EXTRAOBJ = strcasecmp.o getopt.o getopt1.o alloca.o

# Common prefix for machine-independent installed files.
prefix = @prefix@
# Common prefix for machine-dependent installed files.
exec_prefix = @exec_prefix@

# Directory in which to install.
bindir = @bindir@
# Directory to install the Info files in.
infodir = @infodir@
# Number to put on the man page filename.
manext = 1
# Directory to install the man page in.
mandir = @mandir@/man$(manext)

# Program to install `make'.
INSTALL_PROGRAM = @INSTALL_PROGRAM@
# Program to install the man page.
INSTALL_DATA = @INSTALL_DATA@
# Generic install program.
INSTALL = @INSTALL@

# Program to format Texinfo source into Info files.
MAKEINFO = makeinfo
# Program to format Texinfo source into DVI files.
TEXI2DVI = texi2dvi

# Programs to make tags files.
ETAGS = etags
CTAGS = ctags

protobjs = rcfile_y.o rcfile_l.o socket.o getpass.o pop2.o pop3.o imap.o \
       etrn.o fetchmail.o env.o options.o daemon.o driver.o rfc822.o smtp.o \
       xmalloc.o uid.o mxget.o md5c.o md5ify.o rpa.o interface.o netrc.o \
       base64.o error.o unmime.o conf.o

objs = $(protobjs) $(extras) $(EXTRAOBJ)

srcs = $(srcdir)/socket.c $(srcdir)/getpass.c $(srcdir)/pop2.c 		\
       $(srcdir)/pop3.c $(srcdir)/imap.c $(srcdir)/etrn.c 		\
       $(srcdir)/fetchmail.c $(srcdir)/env.c				\
       $(srcdir)/options.c $(srcdir)/daemon.c 				\
       $(srcdir)/driver.c $(srcdir)/rfc822.c $(srcdir)/smtp.c		\
       $(srcdir)/xmalloc.c $(srcdir)/uid.c $(srcdir)/mxget.c 		\
       $(srcdir)/md5c.c $(srcdir)/md5ify.c $(srcdir)/rpa.c	  	\
       $(srcdir)/interface.c $(srcdir)/netrc.c $(srcdir)/base64.c	\
       $(srcdir)/error.c $(srcdir)/unmime.c $(srcdir)/conf.c

.SUFFIXES:
.SUFFIXES: .o .c .h .y .l .ps .dvi .info .texi

all: fetchmail

# Some makes apparently use .PHONY as the default goal if it is before `all'.
.PHONY: all

fetchmail: $(objs)
	$(CC) $(LDEFLAGS) $(LDFLAGS) $(objs) $(LOADLIBS) -o fetchmail

# Tester for address parsing
rfc822: rfc822.c
	gcc -DTESTMAIN -g rfc822.c -o rfc822

# Stand-alone MIME decoder
unmime: unmime.c base64.c rfc822.c xmalloc.c error.c memmove.c
	$(CC) -DSTANDALONE -g -o $@ $^ 

.c.o:
	$(CC) $(defines) -c -I$(srcdir) -I. $(CEFLAGS) $(CFLAGS) $<

# For some losing Unix makes.
SHELL = /bin/sh
MAKE = make

tagsrcs = $(srcs) rcfile_l.c rcfile_y.c
TAGS: $(tagsrcs)
	$(ETAGS) $(tagsrcs)
tags: $(tagsrcs)
	$(CTAGS) $(tagsrcs)

.PHONY: install uninstall
install:
	@echo "Creating installation directories..." 
	$(SHELL) ${srcdir}/mkinstalldirs $(bindir) $(mandir)
	@echo "Installing fetchmail binary..."
	$(INSTALL_PROGRAM) ${srcdir}/fetchmail $(bindir)/fetchmail
	@echo "Installing fetchmail configurator..."
	$(INSTALL_PROGRAM) ${srcdir}/fetchmailconf $(bindir)/fetchmailconf
	@echo "Installing manual page..."
	$(INSTALL_DATA) $(srcdir)/fetchmail.man $(mandir)/fetchmail.$(manext)
	ln -sf $(mandir)/fetchmail.$(manext) $(mandir)/fetchmailconf.$(manext)

uninstall:
	rm -f $(bindir)/fetchmail $(bindir)/fetchmailconf
	rm -f $(mandir)/fetchmail.$(manext) $(mandir)/fetchmailconf.$(manext)

.PHONY: clean realclean distclean mostlyclean
clean: 
	-rm -f fetchmail *.o core fetchmail.dvi \
	       rcfile_l.c rcfile_y.h rcfile_y.c \
	       fetchmail.tar fetchmail.tar.gz \
	       rfc822 unmime

distclean: clean 
	-rm -f Makefile config.h TAGS tags
	-rm -f config.cache config.status config.log stamp-config

realclean: distclean
	-rm -f FAQ FEATURES NOTES MANIFEST 
	-rm -f config.cache config.log Makefile
	-rm -f fetchmail-*.tar.gz fetchmail-*.rpm 

mostlyclean: clean

config.status: configure
	$(srcdir)/configure

config.h: config.status config.h.in
	sh config.status; touch config.h

Makefile: config.status Makefile.in
	sh config.status

configure: configure.in
	autoconf $(ACFLAGS)

config.h.in: acconfig.h configure.in
	autoheader $(ACFLAGS); touch config.h.in

# This tells versions [3.59,3.63) of GNU make not to export all variables.
.NOEXPORT:

# Special dependencies, not easily handled portably without explicit rules
rcfile_l.c rcfile_l.h: $(srcdir)/rcfile_l.l
	$(LEX) $(LEXFLAGS) $(srcdir)/rcfile_l.l
	mv lex.yy.c rcfile_l.c
rcfile_y.c rcfile_y.h: $(srcdir)/rcfile_y.y
	@echo "expect conflicts:  2 shift/reduce"
	$(YACC) $(YACCFLAGS) $(srcdir)/rcfile_y.y
	mv y.tab.c rcfile_y.c
	mv -f y.tab.h rcfile_y.h

# These must be explicit, because the .c files often don't exist at
# makefile build time. 
rcfile_l.o: rcfile_y.c rcfile_y.h config.h fetchmail.h
rcfile_y.o: rcfile_y.c rcfile_y.h config.h fetchmail.h

parser = $(srcdir)/rcfile_l.l $(srcdir)/rcfile_y.y
headers = $(srcdir)/fetchmail.h $(srcdir)/socket.h $(srcdir)/smtp.h \
	$(srcdir)/mx.h $(srcdir)/md5.h $(srcdir)/md5global.h \
	$(srcdir)/netrc.h $(srcdir)/tunable.h
extra = $(srcdir)/alloca.c $(srcdir)/getopt.[ch] $(srcdir)/getopt1.c \
	$(srcdir)/strcasecmp.c $(srcdir)/strstr.c $(srcdir)/memmove.c
docs = $(srcdir)/COPYING $(srcdir)/FEATURES $(srcdir)/fetchmail-features.html \
	$(srcdir)/design-notes.html $(srcdir)/NOTES \
	$(srcdir)/INSTALL $(srcdir)/NEWS  $(srcdir)/README \
	$(srcdir)/fetchmail.lsm $(srcdir)/sample.rcfile \
	$(srcdir)/*.man	$(srcdir)/FAQ $(srcdir)/fetchmail-FAQ.html
config = $(srcdir)/Makefile.in $(srcdir)/configure.in $(srcdir)/configure \
	$(srcdir)/config.guess $(srcdir)/config.h.in $(srcdir)/config.sub \
	$(srcdir)/acconfig.h
scripts = $(srcdir)/install.sh $(srcdir)/mkinstalldirs \
	$(srcdir)/specgen.sh $(srcdir)/lsmgen.sh $(srcdir)/fetchmailconf
all = $(docs) $(config) $(srcs) $(parser) $(headers) $(extra) $(scripts) \
	$(srcdir)/contrib/*[A-Za-uw-z] $(srcdir)/MANIFEST

MANIFEST: $(srcdir) Makefile.in
	@echo $(all) | tr "[ \t]" '\n' | sed -e '/^\.\//s///' | sort >MANIFEST
	@wc -l MANIFEST

FAQ: fetchmail-FAQ.html
	echo "   (This document was generated from fetchmail-FAQ.html)" >FAQ
	lynx -dump -nolist fetchmail-FAQ.html >>FAQ

FEATURES: fetchmail-features.html
	echo "   (This document was generated from fetchmail-features.html)" >FEATURES
	lynx -dump -nolist fetchmail-features.html | grep -v "Back to " >>FEATURES

NOTES: design-notes.html
	echo "   (This document was generated from design-notes.html)" >NOTES
	lynx -dump -nolist design-notes.html | grep -v "Back to " >NOTES

# Make distribution, update LSM with proper size, remake distribution
dist: Makefile.in  
	rm -f MANIFEST; make MANIFEST;
	make fetchmail-$(VERS).tar.gz 
	lsmgen.sh $(VERS) `wc -c fetchmail-$(VERS).tar.gz` >fetchmail.lsm
	make fetchmail-$(VERS).tar.gz
	ls -l fetchmail-$(VERS).tar.gz
	@echo "Don't forget to build RPMs from root!"

# This requires my patch to tar-1.12, or a stock tar-1.13 (not yet released);
# the version must implement the --name-prefix option.
fetchmail-$(VERS).tar.gz: $(all)
	tar --name-prefix='fetchmail-$(VERS)/' -czf fetchmail-$(VERS).tar.gz `cat MANIFEST`

# Make RPMs.  You need to be root to make this work
RPMROOT=/usr/src/redhat
RPM = rpm
RPMFLAGS = -ba
rpm: dist
	cp fetchmail-$(VERS).tar.gz fetchmail.gif $(RPMROOT)/SOURCES;
	$(srcdir)/specgen.sh $(VERS) >$(RPMROOT)/SPECS/fetchmail.spec
	cd $(RPMROOT)/SPECS; $(RPM) $(RPMFLAGS) fetchmail.spec	
	cp $(RPMROOT)/RPMS/`arch|sed 's/i[4-9]86/i386/'`/fetchmail-$(VERS)*.rpm $(srcdir)
	cp $(RPMROOT)/SRPMS/fetchmail-$(VERS)*.src.rpm $(srcdir)

# The following sets edit modes for GNU EMACS.
# Local Variables:
# compile-command:"configure"
# End:

# Automatically generated dependencies will be put at the end of the makefile.
